From 404d45ca7974f093cc3bfc5dde17c33483c886a5 Mon Sep 17 00:00:00 2001
From: Konstantinos Tsakalozos <konstantinos.tsakalozos@canonical.com>
Date: Tue, 5 Jul 2016 20:25:27 +0300
Subject: [PATCH 1/1] BIGTOP-2490: Spark in HA when Zookeeper is available

---
 bigtop-deploy/puppet/modules/spark/manifests/init.pp             | 8 ++++++++
 bigtop-deploy/puppet/modules/spark/templates/spark-defaults.conf | 3 +++
 bigtop-deploy/puppet/modules/spark/templates/spark-env.sh        | 2 ++
 bigtop-packages/src/common/spark/spark-worker.svc                | 2 +-
 4 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/bigtop-deploy/puppet/modules/spark/manifests/init.pp b/bigtop-deploy/puppet/modules/spark/manifests/init.pp
index f5a2d64..9ec38c1 100644
--- a/bigtop-deploy/puppet/modules/spark/manifests/init.pp
+++ b/bigtop-deploy/puppet/modules/spark/manifests/init.pp
@@ -137,6 +137,7 @@ class spark {
   class common(
       $master_url = 'yarn',
       $master_host = $fqdn,
+      $zookeeper_connection_string = undef,
       $master_port = 7077,
       $worker_port = 7078,
       $master_ui_port = 8080,
@@ -158,6 +159,13 @@ class spark {
       ensure => latest,
     }
 
+    if $zookeeper_connection_string {
+      $spark_daemon_java_opts = "\"-Dspark.deploy.recoveryMode=ZOOKEEPER -Dspark.deploy.zookeeper.url=${zookeeper_connection_string}\""
+    }
+    else {
+      $spark_daemon_java_opts = "\"-Dspark.deploy.recoveryMode=NONE\""
+    }
+
     file { '/etc/spark/conf/spark-env.sh':
       content => template('spark/spark-env.sh'),
       require => Package['spark-core'],
diff --git a/bigtop-deploy/puppet/modules/spark/templates/spark-defaults.conf b/bigtop-deploy/puppet/modules/spark/templates/spark-defaults.conf
index 30946b3..fec8181 100644
--- a/bigtop-deploy/puppet/modules/spark/templates/spark-defaults.conf
+++ b/bigtop-deploy/puppet/modules/spark/templates/spark-defaults.conf
@@ -17,6 +17,9 @@ spark.master <%= @master_url %>
 spark.eventLog.enabled true
 spark.eventLog.dir <%= @event_log_dir %>
 spark.history.fs.logDirectory <%= @history_log_dir %>
+<%   if @zookeeper_connection_string.to_s == '' -%>
 spark.yarn.historyServer.address <%= @master_host %>:<%= @history_ui_port %>
+
+<%   end -%>
 spark.history.ui.port <%= @history_ui_port %>
 spark.shuffle.service.enabled <%= @use_yarn_shuffle_service %>
diff --git a/bigtop-deploy/puppet/modules/spark/templates/spark-env.sh b/bigtop-deploy/puppet/modules/spark/templates/spark-env.sh
index eb351c7..0aabc65 100755
--- a/bigtop-deploy/puppet/modules/spark/templates/spark-env.sh
+++ b/bigtop-deploy/puppet/modules/spark/templates/spark-env.sh
@@ -16,6 +16,7 @@
 
 export SPARK_HOME=${SPARK_HOME:-/usr/lib/spark}
 export SPARK_LOG_DIR=${SPARK_LOG_DIR:-/var/log/spark}
+export SPARK_DAEMON_JAVA_OPTS=<%= @spark_daemon_java_opts %>
 export HADOOP_HOME=${HADOOP_HOME:-/usr/lib/hadoop}
 export HADOOP_CONF_DIR=${HADOOP_CONF_DIR:-/etc/hadoop/conf}
 export HIVE_CONF_DIR=${HIVE_CONF_DIR:-/etc/hive/conf}
@@ -23,6 +24,7 @@ export HIVE_CONF_DIR=${HIVE_CONF_DIR:-/etc/hive/conf}
 export STANDALONE_SPARK_MASTER_HOST=<%= @master_host %>
 export SPARK_MASTER_PORT=<%= @master_port %>
 export SPARK_MASTER_IP=$STANDALONE_SPARK_MASTER_HOST
+export SPARK_MASTER_URL=<%= @master_url %>
 export SPARK_MASTER_WEBUI_PORT=<%= @master_ui_port %>
 
 export SPARK_WORKER_DIR=${SPARK_WORKER_DIR:-/var/run/spark/work}
diff --git a/bigtop-packages/src/common/spark/spark-worker.svc b/bigtop-packages/src/common/spark/spark-worker.svc
index 7c12374..445d344 100644
--- a/bigtop-packages/src/common/spark/spark-worker.svc
+++ b/bigtop-packages/src/common/spark/spark-worker.svc
@@ -44,7 +44,7 @@ start() {
     fi
 
     su -s /bin/bash $SVC_USER -c "nohup nice -n 0 \
-        ${EXEC_PATH} org.apache.spark.deploy.worker.Worker spark://$SPARK_MASTER_IP:$SPARK_MASTER_PORT $DAEMON_FLAGS \
+        ${EXEC_PATH} org.apache.spark.deploy.worker.Worker $SPARK_MASTER_URL $DAEMON_FLAGS \
         > $LOG_FILE 2>&1 & "'echo $!' > "$PIDFILE"
 
     sleep 3
-- 
2.7.4

